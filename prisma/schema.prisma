// Apply2Campus - Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CONSULTANT
  OPERATION_UNIVERSITY
  OPERATION_ACCOMMODATION
  OPERATION_VISA
  STUDENT
}

enum GmailConnectionStatus {
  connected
  expired
  disconnected
}

model User {
  id           String    @id @default(cuid())
  name         String?
  email        String    @unique
  emailVerified DateTime?
  passwordHash String?
  image        String?
  role         Role      @default(CONSULTANT)
  studentId    String?   @unique  // Öğrenci girişi için: bu kullanıcı hangi Student kaydına bağlı
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  student               Student?                @relation("StudentLogin", fields: [studentId], references: [id], onDelete: Cascade)
  assignedStudents      Student[]               @relation("AssignedConsultant")
  auditLogs             AuditLog[]              @relation("ActorUser")
  consultantNotifications ConsultantNotification[]
  userNotifications      UserNotification[]
  createdOffers          Offer[]
  accounts              Account[]
  sessions              Session[]
  consultantSlots       ConsultantSlot[]       @relation("ConsultantSlots")
  appointmentRequestsAsConsultant AppointmentRequest[] @relation("AppointmentRequestsAsConsultant")
  tasksAssignedBy       Task[]                 @relation("TaskAssignedBy")
  tasksAssignedTo       Task[]                 @relation("TaskAssignedTo")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Stage {
  id        String   @id @default(cuid())
  slug      String   @unique  // lead, applied, reviewing, visa, enrolled
  name      String   // Görünen ad
  sortOrder Int      @default(0)  // Sıralama
  createdAt DateTime @default(now())

  @@index([sortOrder])
}

model Student {
  id                   String    @id @default(cuid())
  name                 String
  studentEmail         String?   // non-Gmail optional
  gmailAddress         String?
  stage                String    @default("lead")  // Stage.slug ile eşleşir; aşama silinirse öğrenci fallback'e taşınır
  assignedConsultantId String?
  visaInstitution      String?   // Kayıt olunan kurum
  visaCity             String?
  visaProgramStartDate DateTime? // Program başlangıç tarihi
  visaNotes            String?   @db.Text // Bilgi (teklifin kabulü vb.)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  studentLogin    User?              @relation("StudentLogin")
  consultant      User?                     @relation("AssignedConsultant", fields: [assignedConsultantId], references: [id], onDelete: SetNull)
  gmailConnection GmailConnection?
  emailMessages   EmailMessage[]
  emailThreads    EmailThread[]
  auditLogs       AuditLog[]
  consultantNotifications ConsultantNotification[]
  folders         Folder[]
  crmValues       CrmValue[]
  documents       StudentDocument[]
  documentsByCategory StudentDocumentByCategory[]
  offers          Offer[]
  applications   StudentApplication[]
  appointmentRequests AppointmentRequest[]
  tasks               Task[]

  @@index([assignedConsultantId])
  @@index([stage])
  @@index([gmailAddress])
}

// Danışman müsait saatleri (takvim slotları)
model ConsultantSlot {
  id           String   @id @default(cuid())
  consultantId String
  slotDate     DateTime @db.Date
  startTime    String   // "09:00"
  endTime      String   // "09:30"
  createdAt    DateTime @default(now())

  consultant User @relation("ConsultantSlots", fields: [consultantId], references: [id], onDelete: Cascade)
  appointmentRequests AppointmentRequest[]

  @@index([consultantId])
  @@index([slotDate])
}

// Öğrencinin görüşme talebi
enum AppointmentRequestStatus {
  PENDING
  CONFIRMED
  REJECTED
}

model AppointmentRequest {
  id           String                  @id @default(cuid())
  studentId    String
  consultantId String
  slotId       String
  status       AppointmentRequestStatus @default(PENDING)
  note         String?                 @db.Text
  createdAt    DateTime                @default(now())

  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  consultant User @relation("AppointmentRequestsAsConsultant", fields: [consultantId], references: [id], onDelete: Cascade)
  slot       ConsultantSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([consultantId])
  @@index([slotId])
}

// Danışman ↔ Operasyon görev atama
enum TaskStatus {
  PENDING
  IN_PROGRESS
  DONE
}

model Task {
  id                 String     @id @default(cuid())
  title              String
  description        String?    @db.Text
  assignedById       String
  assignedToId       String
  studentId          String?
  relatedEmailId     String?    @unique // Mail'den görev oluşturulduğunda bağlantı
  status             TaskStatus @default(PENDING)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  assignedBy   User    @relation("TaskAssignedBy", fields: [assignedById], references: [id], onDelete: Cascade)
  assignedTo   User    @relation("TaskAssignedTo", fields: [assignedToId], references: [id], onDelete: Cascade)
  student      Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)
  relatedEmail EmailMessage? @relation("TaskFromEmail", fields: [relatedEmailId], references: [id], onDelete: SetNull)

  @@index([assignedById])
  @@index([assignedToId])
  @@index([studentId])
  @@index([relatedEmailId])
  @@index([status])
}

// CRM: Form bölümleri (Kişisel, Aile, Pasaport, Eğitim, Belgeler) — admin'den düzenlenebilir
model CrmSection {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  fields CrmField[]
}

enum CrmFieldType {
  TEXT
  EMAIL
  TEL
  TEXTAREA
  DATE
  RADIO
  SELECT
  CHECKBOX
  FILE
}

// CRM: Admin'in ekleyip düzenleyebildiği form alanları
model CrmField {
  id             String       @id @default(cuid())
  slug           String       @unique
  label          String
  type           CrmFieldType
  options        Json?
  required       Boolean      @default(false)
  sortOrder      Int          @default(0)
  allowMultiple  Boolean      @default(false)
  sectionId      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  section          CrmSection?       @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  crmValues        CrmValue[]
  studentDocuments StudentDocument[]
}

model CrmValue {
  id         String   @id @default(cuid())
  studentId  String
  crmFieldId String
  value      String   @db.Text
  updatedAt  DateTime @updatedAt

  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  crmField CrmField @relation(fields: [crmFieldId], references: [id], onDelete: Cascade)

  @@unique([studentId, crmFieldId])
  @@index([studentId])
  @@index([crmFieldId])
}

enum DocumentStatus {
  UPLOADED
  APPROVED
  REVISION_REQUESTED
}

model StudentDocument {
  id         String          @id @default(cuid())
  studentId  String
  crmFieldId String
  fileName   String
  filePath   String
  mimeType   String?
  fileSize   Int?
  version    Int             @default(1)
  status     DocumentStatus  @default(UPLOADED)
  uploadedAt DateTime        @default(now())

  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  crmField CrmField @relation(fields: [crmFieldId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([studentId, crmFieldId])
}

enum DocumentCategoryType {
  OPERATION_UPLOADED
  STUDENT_UPLOADED
}

model DocumentCategory {
  id    String                @id @default(cuid())
  slug  String                @unique
  name  String
  type  DocumentCategoryType
  sortOrder Int               @default(0)

  documents StudentDocumentByCategory[]

  @@index([type])
}

model StudentDocumentByCategory {
  id          String          @id @default(cuid())
  studentId   String
  categoryId  String
  fileName    String
  filePath    String
  mimeType    String?
  fileSize    Int?
  version     Int             @default(1)
  status      DocumentStatus  @default(UPLOADED)
  uploadedAt  DateTime        @default(now())
  uploadedBy  String?

  student  Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  category DocumentCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  acceptanceForApplication StudentApplication?

  @@index([studentId])
  @@index([studentId, categoryId])
}

enum ApplicationStatus {
  BASVURU_YAPILDI   // Başvuru yapıldı
  KABUL_BEKLENIYOR  // Kabul bekleniyor
  KABUL_ALINDI      // Kabul alındı
  REDDEDILDI        // Reddedildi
}

model StudentApplication {
  id                    String             @id @default(cuid())
  studentId             String
  universityName        String
  program               String?
  applicationDate       DateTime?
  status                ApplicationStatus  @default(BASVURU_YAPILDI)
  notes                 String?            @db.Text
  acceptanceDocumentId  String?            @unique  // Üniversite Kabulü belgesi yüklendiğinde
  secondInstallmentAmount Decimal?         @db.Decimal(12, 2)  // 2. taksit tutarı
  secondInstallmentDueDate DateTime?       // 2. taksit son ödeme tarihi
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  student               Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  acceptanceDocument    StudentDocumentByCategory? @relation(fields: [acceptanceDocumentId], references: [id], onDelete: SetNull)

  @@index([studentId])
}

model Badge {
  id        String   @id @default(cuid())
  name      String
  color     String?  @default("#137fec")
  createdAt DateTime @default(now())

  emailMessages EmailMessageBadge[]
}

model Folder {
  id          String   @id @default(cuid())
  studentId   String
  name        String
  fromAddress String?
  createdAt   DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
}

model GmailConnection {
  id                    String                @id @default(cuid())
  studentId             String                @unique
  provider              String                @default("gmail")
  accessTokenEncrypted  String?
  refreshTokenEncrypted String?
  expiryDate            DateTime?
  status                GmailConnectionStatus @default(disconnected)
  lastSyncAt            DateTime?
  scopes                String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model EmailMessage {
  id             String    @id @default(cuid())
  studentId      String?   // null = öğrenciye bağlanmamış (operasyon ortak inbox)
  gmailMessageId String
  threadId       String
  from           String?
  to             String?
  cc             String?
  subject        String?
  snippet        String?
  bodyHtml       String?   @db.Text
  internalDate   DateTime?
  labels         String?
  stageTag       String?
  rawPayload     String?   @db.Text
  createdAt      DateTime  @default(now())

  student          Student?           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  emailMessageBadges EmailMessageBadge[]
  internalNotes    EmailInternalNote[]
  tasksFromMail    Task[]             @relation("TaskFromEmail")

  @@unique([studentId, gmailMessageId])
  @@index([studentId])
  @@index([studentId, internalDate])
  @@index([threadId])
  @@index([internalDate])
}

model EmailInternalNote {
  id             String   @id @default(cuid())
  emailMessageId String
  userId         String
  note           String   @db.Text
  createdAt      DateTime @default(now())

  emailMessage EmailMessage @relation(fields: [emailMessageId], references: [id], onDelete: Cascade)

  @@index([emailMessageId])
}

model EmailMessageBadge {
  emailMessageId String
  badgeId        String
  createdAt      DateTime @default(now())

  emailMessage EmailMessage @relation(fields: [emailMessageId], references: [id], onDelete: Cascade)
  badge        Badge        @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([emailMessageId, badgeId])
}

model EmailThread {
  id            String    @id @default(cuid())
  studentId     String
  threadId      String
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, threadId])
  @@index([studentId])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorUserId String
  studentId  String?
  type       String   // connect, disconnect, send_email, token_refresh_failure, etc.
  message    String?  @db.Text
  level      String   @default("info") // info, warning, error, critical
  createdAt  DateTime @default(now())

  actor  User     @relation("ActorUser", fields: [actorUserId], references: [id], onDelete: Cascade)
  student Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@index([actorUserId])
  @@index([studentId])
  @@index([createdAt])
}

// Genel bildirimler: duyuru, teklif gönderildi vb. (öğrenci + danışman)
model UserNotification {
  id         String    @id @default(cuid())
  userId     String
  type       String    // ANNOUNCEMENT | OFFER_SENT
  title      String
  message    String?   @db.Text
  linkHref   String?
  relatedId  String?   // announcementId veya offerId
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, readAt])
}

// Danışmana giden bildirimler: yeni öğrenci atandı / öğrenci bilgisi güncellendi
model ConsultantNotification {
  id         String    @id @default(cuid())
  userId     String    // danışman
  type       String    // STUDENT_ASSIGNED | STUDENT_UPDATED
  studentId  String
  message    String?   @db.Text
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, readAt])
}

// Etkinlikler – Duyurular (öğrenci genel bakış)
model Announcement {
  id             String    @id @default(cuid())
  type           String    // DUYURU | ETKINLIK
  title          String
  body           String?   @db.Text
  startDate      DateTime? @db.Date
  endDate        DateTime? @db.Date
  sortOrder      Int       @default(0)
  active         Boolean   @default(true)
  targetAudience String    @default("ALL") // STUDENTS | CONSULTANTS | ALL
  createdAt      DateTime  @default(now())

  @@index([active])
  @@index([sortOrder])
}

// Kurum Kartı – teklifte kurum + başlangıç/bitiş tarihi ile fiyat
enum InstitutionType {
  UNIVERSITY
  LANGUAGE_COURSE
  ACCOMMODATION
  OTHER
}

model Institution {
  id              String          @id @default(cuid())
  type            InstitutionType
  name            String
  logoUrl         String?
  description     String?         @db.Text
  address         String?         @db.Text
  catalogPdfPath  String?         // Katalog PDF (yüklenen dosya)
  sortOrder       Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  services InstitutionService[]
  images   InstitutionImage[]

  @@index([type])
}

model InstitutionImage {
  id            String   @id @default(cuid())
  institutionId String
  filePath      String
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([institutionId])
}

enum InstitutionServiceGroup {
  EDUCATION
  ACCOMMODATION
  OTHER
}

model InstitutionService {
  id            String                 @id @default(cuid())
  institutionId String
  group         InstitutionServiceGroup
  name          String
  sortOrder     Int                    @default(0)
  createdAt     DateTime               @default(now())

  institution Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  prices      InstitutionPrice[]

  @@index([institutionId])
}

model InstitutionPrice {
  id            String    @id @default(cuid())
  serviceId     String
  startDate     DateTime  @db.Date
  endDate       DateTime  @db.Date
  amount        Decimal   @db.Decimal(12, 2)
  currency      String    @default("EUR")
  createdAt     DateTime  @default(now())

  service InstitutionService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([serviceId, startDate, endDate])
}

// Teklif kataloğu – ürün/attribute yapısı (ülke + şehir, okul, program + süre fiyatları)
// attributes: { "2": 1500, "8": 4000, "currency": "EUR", ... }
model CatalogItem {
  id         String   @id @default(cuid())
  country    String   // Ülke (CSV Ulke veya import sırasında seçilen)
  city       String   // Şehir
  schoolName String   // Okul Adı
  program    String   // Program
  attributes Json?    // Süre fiyatları + para birimi + isteğe bağlı alanlar
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  @@index([country])
  @@index([country, city])
  @@index([country, city, schoolName])
  @@map("catalog_item")
}

// Öğrenciye gönderilen teklif
model Offer {
  id           String    @id @default(cuid())
  studentId    String
  createdById  String    // danışman/admin
  title        String
  summary      String?   @db.Text
  body         String?   @db.Text
  status       String    @default("DRAFT") // DRAFT | SENT | VIEWED | ACCEPTED | REJECTED | REVISION_REQUESTED
  sentAt       DateTime?
  viewedAt     DateTime?
  respondedAt  DateTime?
  responseNote String?   @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdBy  User       @relation(fields: [createdById], references: [id], onDelete: Cascade)
  items      OfferItem[]
  @@index([studentId])
  @@index([createdById])
  @@index([status])
}

// Teklif kalemi (gönderilirken katalogdan veya kurum kartından kopyalanan anlık veri)
model OfferItem {
  id            String   @id @default(cuid())
  offerId       String
  city          String
  schoolName    String   // Okul Adı (legacy veya kurum adı)
  program       String
  programGroup  String?  // Program_Grup: Eğitim, Konaklama, Diğer vb.
  durationWeeks Int?     // 2, 8, 12, 16 (legacy); kurum kartında startDate-endDate kullanılır
  amount        Decimal  @db.Decimal(12, 2)
  currency      String?  // EUR, USD, ...
  sortOrder     Int      @default(0)
  // Kurum kartından eklendiğinde:
  institutionId String?
  startDate     DateTime? @db.Date
  endDate       DateTime? @db.Date

  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  @@index([offerId])
}
